/*
 * Copyright 2022 Liju Jayakumar. All Rights Reserved.
*/

/*jshint esversion: 6 */

function clean_up(inputText) {

    inputText = inputText.replace(/S/g, "5");
    inputText = inputText.replace(/ï¿½/g, EMPTY);
    inputText = inputText.replace(/O/gi, 0);
    inputText = inputText.replace(/l/gi, 1);
    return inputText;
}

function parse() {

    // cleanup
    let inputText = clean_up(txtInput.value);
    txtInput.value = inputText;
    txtOutput.value = EMPTY;
    txtVirtualOutput.value = EMPTY;

    // prepare
    let patterns = inputPatterns.options;

    // results
    let result = new Array();
    let autoGenResult = new Array();

    // extract
    for (let i = 0; i < patterns.length; i++) {
        let pattern = patterns[i].value;
        const regex = new RegExp(pattern, "gm");
        let pattern_matched;

        while ((pattern_matched = regex.exec(inputText)) !== null) {
            if (pattern_matched.index === regex.lastIndex) {
                regex.lastIndex++;
            }

            pattern_matched.forEach((match) => {
                let phone_number = match
                    .replace(/ /g, EMPTY)
                    .replace(/-/g, EMPTY);

                result.push(phone_number);
                
                if (chkReplaceInput.checked) {
                    txtInput.value = txtInput.value.replace(match, EMPTY);
                }

                if (chkAutoGenerate.checked) {
                    autoGenNumbers(phone_number, autoGenResult);
                }
            });
        }
    }

    // show results
    txtOutput.value = removeDuplicate(result)
    txtVirtualOutput.value = removeDuplicate(autoGenResult);
    
    lblResult.innerHTML = setCount(RESULT, txtOutput);
    lblAutogenerated.innerHTML = setCount(AUTO_GENERATED, txtVirtualOutput);

    showHideDownload();
    
    notify("Done");
}

function autoGenNumbers(phone_number, autoGenResult){
    for (let index = 0; index < 10; index++) {
        let auto_gen_number = phone_number.slice(0, -1) + index;

        if (auto_gen_number != phone_number) {
            autoGenResult.push(auto_gen_number);
        }
    }
}

function setCount(title, control) {
    return `${title} (${getLength(control)}) Numbers`;
}

function getLength(element) {
    return element.value.split("\n").length - 1;
}

function handleFileSelect(event) {
    readFile(event.files[0]);
}

function clearAll() {

    txtInput.value = EMPTY;
    txtOutput.value = EMPTY;
    txtVirtualOutput.value = EMPTY;
    fileUploadInput.value = EMPTY;

    lblResult.innerHTML = RESULT;
    lblAutogenerated.innerHTML = AUTO_GENERATED;
    fileUploadInput.value = EMPTY;

    showHideDownload();
}

function showHideDownload() {

    setVisible(btnDownload, txtOutput.value);
    setVisible(btnOutputCopy, txtOutput.value);

    setVisible(btnVirtualOutputDownload, txtVirtualOutput.value);
    setVisible(btnAutoOutputCopy, txtVirtualOutput.value);
}

function setVisible(element, condition) {
    element.style.visibility = condition ? VISIBLE : HIDDEN;
}

function initialize() {

    txtInput = document.querySelector("#input-text");
    inputPatterns = document.querySelector("#input-patterns");
    txtOutput = document.querySelector("#output-text");
    txtVirtualOutput = document.querySelector("#auto-output-text");
    fileUploadInput = document.querySelector("#fileInput");

    btnDownload = document.querySelector("#output-download");
    btnVirtualOutputDownload = document.querySelector("#auto-output-download");

    btnOutputCopy = document.querySelector("#output-copy");
    btnAutoOutputCopy = document.querySelector("#auto-output-copy");

    btnParse = document.querySelector("#btnParse");
    btnClear = document.querySelector("#btnClear");
    lblResult = document.querySelector("#lblResult");
    lblAutogenerated = document.querySelector("#lblAutogenerated");

    notification = document.querySelector("#notification");
    notificationText = document.querySelector("#lblNotificationText");

    chkAutoGenerate = document.querySelector("#chkAutoGenerate");
    chkReplaceInput = document.querySelector("#chkReplaceNumber");

    clearAll();
}